// ============================================================
// SCHEMA PRISMA - Sistema de Gestão Socioemocional
// Multi-tenant (isolamento por tenantId em todas as tabelas)
// Compatível com Supabase (PostgreSQL)
// ============================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================
// MULTI-TENANCY: Cada escola é um Tenant isolado
// ============================================================

model Tenant {
  id        String   @id @default(cuid())
  name      String   // Nome da escola
  slug      String   @unique // URL-friendly identifier
  cnpj      String?  @unique // CNPJ da escola (Brasil)
  address   String?
  city      String?
  state     String?  @db.VarChar(2)
  phone     String?
  email     String?
  logoUrl   String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relações
  users            User[]
  students         Student[]
  assessments      Assessment[]
  interventionLogs InterventionLog[]
  classrooms       Classroom[]

  @@map("tenants")
}

// ============================================================
// AUTENTICAÇÃO E RBAC
// ============================================================

enum Role {
  ADMIN        // Administrador SaaS (acesso total cross-tenant)
  MANAGER      // Gestor escolar (acesso total do tenant)
  PSYCHOLOGIST // Psicólogo escolar (acesso a dados clínicos)
  COUNSELOR    // Orientador educacional (acesso pedagógico)
  TEACHER      // Professor (vê riscos, não vê histórico clínico)
  STUDENT      // Aluno (vê apenas suas forças)
}

model User {
  id            String   @id @default(cuid())
  tenantId      String
  email         String
  name          String
  role          Role
  supabaseUid   String?  @unique // Link com Supabase Auth
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relações
  tenant                Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  teacherScreenings     Assessment[]      @relation("ScreeningTeacher")
  interventionLogs      InterventionLog[] @relation("InterventionAuthor")

  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([supabaseUid])
  @@map("users")
}

// ============================================================
// ALUNOS
// ============================================================

enum GradeLevel {
  ANO_1_EM  // 1ª Série do Ensino Médio
  ANO_2_EM  // 2ª Série do Ensino Médio
  ANO_3_EM  // 3ª Série do Ensino Médio
}

model Student {
  id            String     @id @default(cuid())
  tenantId      String
  name          String
  birthDate     DateTime?
  grade         GradeLevel
  classroomId   String?
  enrollmentId  String?    // Matrícula escolar
  guardianName  String?
  guardianPhone String?
  guardianEmail String?
  isActive      Boolean    @default(true)
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  // Relações
  tenant           Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  classroom        Classroom?        @relation(fields: [classroomId], references: [id])
  assessments      Assessment[]
  interventionLogs InterventionLog[]

  @@unique([tenantId, enrollmentId])
  @@index([tenantId])
  @@index([tenantId, grade])
  @@index([classroomId])
  @@map("students")
}

model Classroom {
  id        String     @id @default(cuid())
  tenantId  String
  name      String     // Ex: "91", "92", "1A"
  grade     GradeLevel
  year      Int        // Ano letivo (2025, 2026...)
  shift     String?    // Manhã, Tarde, Integral
  createdAt DateTime   @default(now())

  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  students Student[]

  @@unique([tenantId, name, year])
  @@index([tenantId])
  @@map("classrooms")
}

// ============================================================
// AVALIAÇÕES (Assessment): Armazena respostas brutas e scores
// ============================================================

enum AssessmentType {
  VIA_STRENGTHS   // Questionário de 71 itens (autoaplicado pelo aluno)
  SRSS_IE         // Triagem de risco de 12 itens (preenchido pelo professor)
}

enum ScreeningWindow {
  DIAGNOSTIC  // Março (30-45 dias após início)
  MONITORING  // Junho/Julho (final 1º semestre)
  FINAL       // Outubro (meio 2º semestre)
}

enum RiskTier {
  TIER_1  // Verde - Baixo Risco
  TIER_2  // Amarelo - Risco Moderado
  TIER_3  // Vermelho - Alto Risco
}

model Assessment {
  id               String           @id @default(cuid())
  tenantId         String
  studentId        String
  type             AssessmentType
  screeningWindow  ScreeningWindow
  academicYear     Int              // Ex: 2025
  appliedAt        DateTime         @default(now())

  // Quem preencheu (para SRSS-IE = professor; para VIA = null/aluno)
  screeningTeacherId String?

  // --- Respostas Brutas (JSON) ---
  // VIA: { "1": 3, "2": 4, ..., "71": 2 }
  // SRSS-IE: { "1": 0, "2": 1, ..., "12": 3 }
  rawAnswers       Json

  // --- Scores Processados (JSON) ---
  // VIA: { strengths: [...24 scores], signatureTop5: [...] }
  // SRSS-IE: { externalizing: {score, tier, color}, internalizing: {score, tier, color} }
  processedScores  Json?

  // --- Campos desnormalizados para queries rápidas ---
  // (preenchidos pelo motor de scoring ao salvar)
  overallTier          RiskTier?
  externalizingScore   Int?
  internalizingScore   Int?
  selfKnowledgeScore   Int?     // Escala 1-10 do autoconhecimento

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relações
  tenant           Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  student          Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  screeningTeacher User?   @relation("ScreeningTeacher", fields: [screeningTeacherId], references: [id])

  @@index([tenantId])
  @@index([tenantId, studentId])
  @@index([tenantId, type, screeningWindow, academicYear])
  @@index([tenantId, overallTier])
  @@index([studentId, type, appliedAt])
  @@map("assessments")
}

// ============================================================
// INTERVENÇÕES: Registro de ações para Tier 2 e Tier 3
// ============================================================

enum InterventionStatus {
  PLANNED     // Planejada
  IN_PROGRESS // Em andamento
  COMPLETED   // Concluída
  CANCELLED   // Cancelada
}

enum InterventionType {
  // Camada 2
  SOCIAL_SKILLS_GROUP    // Grupo de Habilidades Sociais (Del Prette)
  EMOTION_REGULATION     // Oficina de Regulação Emocional / Mindfulness
  CAREER_GUIDANCE        // Orientação Profissional (3ª série)
  PEER_MENTORING         // Mentoria entre pares (padrinho)
  STUDY_SKILLS           // Oficina de hábitos de estudo
  // Camada 3
  INDIVIDUAL_PLAN        // PEI - Plano Educacional Individualizado
  PSYCHOLOGIST_REFERRAL  // Encaminhamento para psicólogo escolar
  EXTERNAL_REFERRAL      // Encaminhamento externo (CAPS, psiquiatra)
  CRISIS_PROTOCOL        // Protocolo de crise (ideação suicida, autolesão)
  FAMILY_MEETING         // Reunião com família
  CHECK_IN_CHECK_OUT     // Mentoria diária (check-in/check-out)
}

model InterventionLog {
  id          String             @id @default(cuid())
  tenantId    String
  studentId   String
  authorId    String             // Quem registrou a intervenção
  type        InterventionType
  status      InterventionStatus @default(PLANNED)
  tier        RiskTier           // Tier que motivou a intervenção

  title       String
  description String?            @db.Text
  goals       String?            @db.Text  // Metas da intervenção
  observations String?           @db.Text  // Anotações qualitativas (acesso restrito)

  // Campos do cruzamento preditivo (forças usadas como alavanca)
  leverageStrengths String[]     // Ex: ["CRIATIVIDADE", "HUMOR"]
  targetRisks       String[]     // Ex: ["Apatia emocional"]

  startDate   DateTime?
  endDate     DateTime?
  nextReview  DateTime?          // Data da próxima revisão

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relações
  tenant  Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  author  User    @relation("InterventionAuthor", fields: [authorId], references: [id])

  @@index([tenantId])
  @@index([tenantId, studentId])
  @@index([tenantId, status])
  @@index([tenantId, tier])
  @@map("intervention_logs")
}
